server {
    listen 80;
    server_name localhost;
# Use an explicitly configured host value to prevent host header injection
return 301 https://localhost$request_uri;
}

server {
    listen 443 ssl;
    server_name localhost;

    ssl_certificate /etc/nginx/certs/server.crt;
    ssl_certificate_key /etc/nginx/certs/server.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # Frontend
    location / {
        proxy_pass http://web:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host web;  # Replace 'web' with the actual upstream domain if different

# In /api/ location:
        proxy_set_header Host api;  # Replace 'api' with the actual upstream domain if different
        proxy_cache_bypass $http_upgrade;
    }

    # API
    location /api/ {
        proxy_pass http://api:8000/;
        proxy_http_version 1.1;
# Set Host header to a fixed, validated domain to prevent host header injection
proxy_set_header Host example.com;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # RAG Engine
    location /rag/ {
        proxy_pass http://rag-engine:8000/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # MinIO Console (Optional, expose via a different port or path?
    # Let's verify requirements. "only NGINX exposed publicly".
    # User might want to access MinIO console. Maybe /minio-console/?
    # MinIO console is tricky with subpaths without config.
    # For now, I won't expose MinIO publicly through NGINX unless requested.
    # The requirement says "internal networking; only NGINX exposed publicly".
    # So if I want to access MinIO, I should proxy it.
    # But for now, let's stick to App + API.
}
