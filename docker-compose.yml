version: '3.8'

x-logging: &logging
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"

services:
  # ---------------------------------------------------------------------------
  # DATA STORES
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:15-alpine
    container_name: vantus-postgres
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-vantus}
    volumes:
      - ${DATA_DIR:-./data}/postgres:/var/lib/postgresql/data
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    <<: *logging

  minio:
    image: minio/minio:RELEASE.2023-11-20T22-40-07Z
    container_name: vantus-minio
    restart: always
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    volumes:
      - ${DATA_DIR:-./data}/minio:/data
    networks:
      - internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    <<: *logging

  qdrant:
    image: qdrant/qdrant:latest
    container_name: vantus-qdrant
    restart: always
    volumes:
      - ${DATA_DIR:-./data}/qdrant:/qdrant/storage
      - ./infra/qdrant/config.yaml:/qdrant/config/production.yaml
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:6333/healthz || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 5
    <<: *logging

  opensearch:
    image: opensearchproject/opensearch:2.11.0
    container_name: vantus-opensearch
    restart: always
    environment:
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - "OPENSEARCH_JAVA_OPTS=${OPENSEARCH_JAVA_OPTS:--Xms512m -Xmx512m}"
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=${OPENSEARCH_INITIAL_ADMIN_PASSWORD:-Opensearch_secret_1!}
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - ${DATA_DIR:-./data}/opensearch:/usr/share/opensearch/data
    networks:
      - internal
    ports:
      - "9200:9200" # Exposed for now for debugging, but NGINX should proxy
    healthcheck:
      test: ["CMD-SHELL", "curl -k -u admin:${OPENSEARCH_INITIAL_ADMIN_PASSWORD:-Opensearch_secret_1!} https://localhost:9200/_cluster/health || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 5
    <<: *logging

  redis:
    image: redis:7-alpine
    container_name: vantus-redis
    restart: always
    command: redis-server --requirepass ${REDIS_PASSWORD:-redis_secret}
    volumes:
      - ${DATA_DIR:-./data}/redis:/data
    networks:
      - internal
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-redis_secret}", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    <<: *logging

  # ---------------------------------------------------------------------------
  # APPLICATION SERVICES
  # ---------------------------------------------------------------------------
  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    container_name: vantus-api
    restart: always
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-vantus}
      - POSTGRES_HOST=postgres
      - REDIS_HOST=redis
      - REDIS_PASSWORD=${REDIS_PASSWORD:-redis_secret}
      - QDRANT_HOST=qdrant
      - OPENSEARCH_HOST=opensearch
      - OPENSEARCH_PASSWORD=${OPENSEARCH_INITIAL_ADMIN_PASSWORD:-Opensearch_secret_1!}
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}
      - JWT_SECRET=${JWT_SECRET:-super_secret_jwt_key_change_me}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      opensearch:
        condition: service_healthy
    networks:
      - internal
    <<: *logging

  worker:
    build:
      context: .
      dockerfile: apps/worker/Dockerfile
    container_name: vantus-worker
    restart: always
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-vantus}
      - POSTGRES_HOST=postgres
      - REDIS_HOST=redis
      - REDIS_PASSWORD=${REDIS_PASSWORD:-redis_secret}
      - QDRANT_HOST=qdrant
      - OPENSEARCH_HOST=opensearch
      - OPENSEARCH_PASSWORD=${OPENSEARCH_INITIAL_ADMIN_PASSWORD:-Opensearch_secret_1!}
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - internal
    <<: *logging

  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
    container_name: vantus-web
    restart: always
    environment:
      - NEXT_PUBLIC_API_URL=/api
    depends_on:
      api:
        condition: service_started
    networks:
      - internal
    <<: *logging

  rag-engine:
    build:
      context: .
      dockerfile: Dockerfile.rag
    container_name: vantus-rag-engine
    restart: always
    environment:
      - DB_PATH=/data/codegraph.db
      - RAG_MAX_FILE_MB=2
      - LLM_PROVIDER=${LLM_PROVIDER:-openai}
      - LLM_API_KEY=${LLM_API_KEY}
      - LLM_MODEL=${LLM_MODEL:-gpt-4o-mini}
    volumes:
      - ${DATA_DIR:-./data}/rag:/data
    networks:
      - internal
    <<: *logging

  # ---------------------------------------------------------------------------
  # INFERENCE SERVICES (PROFILES)
  # ---------------------------------------------------------------------------
  embedding-cpu:
    image: ghcr.io/huggingface/text-embeddings-inference:cpu-1.2
    container_name: vantus-embedding-cpu
    profiles: ["cpu", "hybrid"]
    command: --model-id BAAI/bge-m3 --port 80
    volumes:
      - ${DATA_DIR:-./data}/tei-cache:/data
    networks:
      - internal
    <<: *logging

  rerank-cpu:
    image: ghcr.io/huggingface/text-embeddings-inference:cpu-1.2
    container_name: vantus-rerank-cpu
    profiles: ["cpu", "hybrid"]
    command: --model-id BAAI/bge-reranker-base --port 80
    volumes:
      - ${DATA_DIR:-./data}/tei-cache:/data
    networks:
      - internal
    <<: *logging

  # GPU Services would go here with 'gpu' profile and resources config

  # ---------------------------------------------------------------------------
  # PROXY
  # ---------------------------------------------------------------------------
  nginx:
    image: nginx:alpine
    container_name: vantus-nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./infra/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./infra/nginx/sites-enabled:/etc/nginx/sites-enabled
      - ./infra/nginx/certs:/etc/nginx/certs
    depends_on:
      - web
      - api
    networks:
      - internal
    <<: *logging

networks:
  internal:
    driver: bridge
